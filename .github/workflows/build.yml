name: CI
on: { push: { branches: [master] } }
env:
  LPM_PLUGINS: https://raw.githubusercontent.com/adamharrison/lite-xl-maintenance/latest/lpm-plugins/gh.lua
permissions:
  contents: write
jobs:
  build_linux_windows:
    runs-on: ubuntu-latest
    defaults: { run: { shell: bash } }
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with: { fetch-depth: 0 }
    - name: Clone Submodules
      run: git submodule update --init --depth=1
    - name: Build Libraries
      run: |
        git config --global user.name "Github Actions" && git config --global user.email "adamdharrison@gmail.com"
        sudo apt-get install -y cmake gcc mingw-w64 gcc-14-aarch64-linux-gnu
        ./build.sh clean && BIN="image.x86_64-linux.so" ./build.sh -O3 -s &&
        ./build.sh clean && BIN="image.aarch64-linux.so" CC=aarch64-linux-gnu-gcc-14 ./build.sh -O3 -s &&
        ./build.sh clean && BIN="image.x86_64-windows.dll" CC=x86_64-w64-mingw32-gcc ./build.sh -O3 -s
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with: { name: "Windows", path: "*.dll" }
    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with: { name: "Linux", path: "*.so" }

  build_macos:
    runs-on: macos-latest
    env:
      CC: clang
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with: { fetch-depth: 0 }
    - name: Clone Submodules
      run: git submodule update --init --depth=1
    - name: Build MacOS
      env: { GITHUB_TOKEN: "${{ github.token }}" }
      run: |
        ./build.sh clean && BIN="image.aarch64-darwin.so" CFLAGS="-arch arm64" LDFLAGS="-arch arm64" ./build.sh -O3 -s
        ./build.sh clean && BIN="image.x86_64-darwin.so" CFLAGS="-arch x86_64" LDFLAGS="-arch x86_64" ./build.sh -O3 -s
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with: { name: "MacOS", path: "*.so" }
        
  finalize:
    needs: [build_macos, build_linux_windows]
    runs-on: ubuntu-latest
    environment: Release
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with: { fetch-depth: 0 }
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with: { path: "." }
    - name: Perform Release
      env: { GITHUB_TOKEN: "${{ github.token }}" }
      run: |
        wget https://github.com/lite-xl/lite-xl-plugin-manager/releases/download/latest/lpm.x86_64-linux -O lpm-latest && chmod +x lpm-latest
        ./lpm-latest gh release Linux/*.so MacOS/*.so Windows/*.dll --addon image

